<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popraw czas pracy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/admin-dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 custom-sidebar">
                <div class="text-center my-3">
                    <a href="/strony/adminDashboard/admin-dashboard.html">
                        <img src="logo.svg" alt="Logo" style="width: 200px; height: auto;">
                        <h1 class="mt-2" style="font-size: 1.8rem;">GR Jesionówka</h1>
                    </a>
                </div>
                <div class="accordion" id="sidebarAccordion">
                    <!-- Akordeon 1 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Pracownicy
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse " aria-labelledby="headingOne"
                            data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body">
                                <a href="../adminDashboard/addpracownik.html">Dodaj pracownika</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/removepracownik.html">Usuń pracownika</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/updatepracownik.html">Zaktualizuj dane pracownika</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/lista.html">Lista pracowników</a>
                            </div>
                        </div>
                    </div>
                    <!-- Akordeon 2 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Czas pracy
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                            data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body">
                                <a href="../adminDashboard/czas_pracy_today.html">Czas pracy dzisiaj</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/czas_pracy_yesterday.html">Czas pracy wczoraj</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/czas_pracy_month.html">Czas pracy w tym miesiącu</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../adminDashboard/czas_pracy_season.html">Czas pracy w tym sezonie</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../czasPracy/popraw-czas-pracy.html">Popraw czas pracy</a>
                            </div>
                        </div>
                    </div>
                    <!-- Akordeon 3 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Strona Adama
                            </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                            data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body">
                                <a href="../../strona-kierowcy.html">Strona Kierowcy</a>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFour">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                Dokumenty
                            </button>
                        </h2>
                        <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour"
                            data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body">
                                <a href="../Inne/generate_documents.html">Generuj wypłaty dla pracowników</a>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingFive">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                                Urlopy
                            </button>
                        </h2>
                        <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive"
                            data-bs-parent="#sidebarAccordion">
                            <div class="accordion-body">
                                <a href="../urlopy/urlopy.html">Lista Urlopów</a><br>
                            </div>
                            <div class="accordion-body">
                                <a href="../urlopy/dodaj_urlop.html">Dodaj Urlop</a><br>
                            </div>
                            <div class="accordion-body">
                                <a href="../urlopy/usun_urlop.html">Usun urlop</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../urlopy/edytuj_urlop.html">Edytuj urlop</a>
                            </div>
                            <div class="accordion-body">
                                <a href="../urlopy/dodaj_urlopy.html">Dodaj urlopy</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Główna treść -->
            <div class="col-md-9 col-lg-10 p-4">
                <!-- navbar tutaj bedzie  -->
                <nav class="navbar navbar-expand-lg custom-navbar">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">Navbar</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                                <li class="nav-item">
                                    <a class="nav-link active" aria-current="page" href="#">Home</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="#">Link</a>
                                </li>
                                <!-- divider -->
                                <li class="nav-item divider"></li>
                                <!-- imie nazwisko i zdjecie uzytkownika -->
                                <li class="nav-item">
                                    <a class="nav-link d-flex" href="#" id="user-name"></a>
                                </li>
                                <li class="nav-item">
                                    <button class="btn btn-danger ms-2" id="logout-btn">Wyloguj się</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </nav>
                <div class=" justify-content-center align-items-center">
                    <!-- Dane: -->
                    <div class="mb-4">
                        <label for="datePicker" class="form-label">Wybierz datę:</label>
                        <input type="date" id="datePicker" class="form-control" onchange="fetchWorkHours()">
                        <button class="btn btn-primary" onclick="fetchWorkHours()">Pobierz dane</button>
                    </div>

                    <!-- Tabela do wyświetlania danych -->
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Imię</th>
                                <th>Nazwisko</th>
                                <th>Drugie Imię</th>
                                <th>Data Pracy</th>
                                <th>Start Pracy</th>
                                <th>Stop Pracy</th>
                                <th>Czas Przerwy</th>
                                <th>Akcja</th> <!-- Nowa kolumna z guzikiem -->
                            </tr>
                        </thead>
                        <tbody id="employeesTableBody">
                            <!-- Wiersze będą generowane dynamicznie -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <p id="message"></p>
    <footer class="footer d-flex flex-wrap justify-content-between align-items-center">
        <p class="col-md-4 mb-0 text-muted">&copy; 2025 GR Jesionówka</p>

        <a href="/"
            class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto  text-decoration-none">
            <svg class="bi me-2" width="40" height="32">
                <use xlink:href="#bootstrap" />
            </svg>
        </a>

        <ul class="nav col-md-4 justify-content-end">
            <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Twórca Gabriel Stachnik</a></li>
            <li class="nav-item"><a href="https://www.github.com/Celiek" class="nav-link px-2 text-muted">Github</a>
            </li>
            <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">Adres email Tworcy: g.stachnik@onet.pl</a>
            </li>
        </ul>
    </footer>
    <script>
        async function fetchWorkHours() {
            const date = document.getElementById("datePicker").value; // Pobieramy wybraną datę
            if (!date) {
                alert("Proszę wybrać datę.");
                return;
            }

            const apiUrl = `http://localhost:8080/api/czasPracy/findCzasPracyByDateId?dataPracy=${date}`;
            const token = localStorage.getItem("token"); // Pobieramy token z localStorage

            try {
                const response = await fetch(apiUrl, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                // Sprawdzamy, czy odpowiedź jest poprawna (status 200)
                if (!response.ok) {
                    throw new Error(`Błąd podczas pobierania danych: ${response.statusText}`);
                }

                // Sprawdzamy, czy odpowiedź zawiera dane JSON
                const data = await response.json();
                console.log("Odpowiedź z serwera:", data);

                // Jeśli dane są puste, informujemy użytkownika
                if (data.length === 0) {
                    alert("Brak danych dla wybranej daty.");
                    return;
                }

                // Wypełniamy tabelę danymi
                const tableBody = document.getElementById("employeesTableBody");
                tableBody.innerHTML = ""; // Czyścimy tabelę przed dodaniem nowych danych

                data.forEach(item => {
                    const row = document.createElement("tr");

                    // Sprawdzamy, czy startPracy i stopPracy mają wartość
                    const startPracy = item[5] || "Brak danych"; // Jeśli brak startPracy, wyświetlamy "Brak danych"
                    const stopPracy = item[6] || "Brak danych"; // Jeśli brak stopPracy, wyświetlamy "Brak danych"
                    const czasPrzerwy = item[7] ? formatInterval(item[7]) : "Brak przerwy"; // Czas przerwy, jeśli brak - "Brak przerwy"

                    row.innerHTML = `
                <td>${item[1]}</td> <!-- Imię -->
                <td>${item[2]}</td> <!-- Nazwisko -->
                <td>${item[3]}</td> <!-- Drugie Imię -->
                <td>${item[4]}</td> <!-- Data Pracy -->
                <td><input type="time" value="${startPracy}" class="form-control" id="startPracy-${item[0]}" /></td> <!-- Start Pracy -->
                <td><input type="time" value="${stopPracy}" class="form-control" id="stopPracy-${item[0]}" /></td> <!-- Stop Pracy -->
                <td><input type="text" value="${czasPrzerwy}" class="form-control" id="czasPrzerwy-${item[0]}" disabled /></td> <!-- Czas Przerwy -->
                <td><button class="btn btn-success btn-sm" onclick="updateWorkHours('${item[0]}')">Zaktualizuj</button></td> <!-- Przycisk -->
            `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error("Błąd podczas pobierania danych:", error);
                alert("Wystąpił błąd podczas pobierania danych. Sprawdź konsolę.");
            }
        }

        // Funkcja do formatowania interval na czytelny tekst
        function formatInterval(interval) {
            if (interval && interval.value) {
                const intervalValue = interval.value;

                // Wyciąganie godzin i minut z wartości 'interval'
                const match = intervalValue.match(/(\d+)\s*hours\s*(\d+)\s*mins/);

                if (match) {
                    const hours = match[1];
                    const minutes = match[2];
                    return `${hours}:${minutes}`;
                }
            }
            return "Brak przerwy"; // Jeśli brak danych, wyświetla 'Brak przerwy'
        }

        // Funkcja do wysłania zaktualizowanych danych
       // Funkcja do wysłania zaktualizowanych danych
        async function updateWorkHours(idPracownika) {
            // Pobieramy wartość dataPracy z inputa (jeśli jest w formularzu)
            const dataPracy = document.getElementById("datePicker").value; // Przykład: input typu date

            if (!dataPracy) {
                alert("Proszę wybrać datę.");
                return;
            }

            const startPracyElement = document.getElementById(`startPracy-${idPracownika}`);
            const stopPracyElement = document.getElementById(`stopPracy-${idPracownika}`);
            const czasPrzerwyElement = document.getElementById(`czasPrzerwy-${idPracownika}`);

            if (!startPracyElement || !stopPracyElement || !czasPrzerwyElement) {
                console.error(`Elementy z ID ${idPracownika} nie zostały znalezione w DOM-ie`);
                return;
            }

            const startPracy = startPracyElement.value;
            const stopPracy = stopPracyElement.value;
            const czasPrzerwy = czasPrzerwyElement.value;

            const apiUrl = `http://localhost:8080/api/czasPracy/updateCzasPracy?dataPracy=${dataPracy}&idPracownika=${idPracownika}&startPracy=${startPracy}&stopPracy=${stopPracy}&czasPrzerwy=${czasPrzerwy}`;
            const token = localStorage.getItem("token");

            try {
                const response = await fetch(apiUrl, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Błąd podczas wysyłania danych: ${response.statusText}`);
                }

                const data = await response.json();
                console.log("Odpowiedź z serwera:", data);
                alert("Dane zostały zaktualizowane!");
            } catch (error) {
                console.error("Błąd podczas wysyłania danych:", error);
                alert("Wystąpił błąd podczas aktualizacji danych.");
            }
        }

    </script>
</body>

</html>